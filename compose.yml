services:
  oracle:
    image: oracle
    container_name: oracle
    ports:
      - 1521:1521
    environment:
      - ORACLE_PWD=oracle
      - NLS_LANG=AMERICAN_AMERICA.AL32UTF8
    volumes:
      - oracle_vol:/opt/oracle/oradata
    networks:
      - msa_net
    deploy:
      resources:
        limits:
          memory: 2g
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "echo 'SELECT 1 FROM DUAL;' | sqlplus -s license/license@//localhost:1521/license"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

  config:
    build:
      context: .
      args:
        SERVICE_NAME: config
    image: config
    container_name: config
    ports:
      - 8070:8070
    networks:
      - msa_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8070/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  eureka:
    build:
      context: .
      args:
        SERVICE_NAME: eureka
    image: eureka
    container_name: eureka
    ports:
      - 8071:8071
    networks:
      - msa_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8071/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  gateway:
    build:
      context: .
      args:
        SERVICE_NAME: gateway
    image: gateway
    container_name: gateway
    ports:
      - 8072:8072
    depends_on:
      - config
      - eureka
    networks:
      - msa_net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8072/actuator/health" ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s

  license:
    build:
      context: .
      args:
        SERVICE_NAME: license
    image: license
    container_name: license
    ports:
      - 8080:8080
    networks:
      - msa_net
    depends_on:
      oracle: {condition: service_healthy}
      config: {condition: service_healthy}
      eureka: {condition: service_healthy}
    restart: unless-stopped

  company:
    build:
      context: .
      args:
        SERVICE_NAME: company
    image: company
    environment:
      - SPRING_PROFILES_ACTIVE=rate
    container_name: company
    ports:
      - 8081:8081
    networks:
      - msa_net
    depends_on:
      oracle: { condition: service_healthy }
      config: { condition: service_healthy }
      eureka: { condition: service_healthy }
    restart: unless-stopped

volumes:
  oracle_vol:
    external: true

networks:
  msa_net:
    external: true